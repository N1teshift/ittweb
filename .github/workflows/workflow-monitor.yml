name: Workflow Monitor

on:
  workflow_run:
    workflows: ["Test", "Build", "Deploy", "Security", "Bundle Size"]
    types: [completed]
  schedule:
    # Run daily check at 9 AM UTC to ensure workflows are running
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger for status check

jobs:
  monitor-workflows:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      actions: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get workflow run information
        id: workflow_info
        if: github.event_name == 'workflow_run'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"
          TRIGGER_EVENT="${{ github.event.workflow_run.event }}"
          
          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "workflow_conclusion=$WORKFLOW_CONCLUSION" >> $GITHUB_OUTPUT
          echo "workflow_run_id=$WORKFLOW_RUN_ID" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "workflow_url=$WORKFLOW_URL" >> $GITHUB_OUTPUT
          echo "trigger_event=$TRIGGER_EVENT" >> $GITHUB_OUTPUT

      - name: Get commit message
        id: commit_info
        if: github.event_name == 'workflow_run'
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" ${{ github.event.workflow_run.head_sha }} 2>/dev/null || echo "Unable to fetch commit message")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" ${{ github.event.workflow_run.head_sha }} 2>/dev/null || echo "Unknown")
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT

      - name: Check for existing failure issue
        id: check_issue
        if: github.event_name == 'workflow_run' && steps.workflow_info.outputs.workflow_conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ steps.workflow_info.outputs.workflow_name }}';
            const commitSha = '${{ steps.workflow_info.outputs.commit_sha }}';
            
            // Search for existing issues with same workflow and commit
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure',
              per_page: 100
            });
            
            const existingIssue = issues.find(issue => 
              issue.body && 
              issue.body.includes(workflowName) && 
              issue.body.includes(commitSha.substring(0, 7))
            );
            
            if (existingIssue) {
              core.setOutput('issue_number', existingIssue.number);
              core.setOutput('issue_exists', 'true');
            } else {
              core.setOutput('issue_exists', 'false');
            }

      - name: Create or update failure issue
        if: |
          github.event_name == 'workflow_run' && 
          steps.workflow_info.outputs.workflow_conclusion == 'failure' &&
          steps.check_issue.outputs.issue_exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ steps.workflow_info.outputs.workflow_name }}';
            const workflowUrl = '${{ steps.workflow_info.outputs.workflow_url }}';
            const workflowRunId = '${{ steps.workflow_info.outputs.workflow_run_id }}';
            const commitSha = '${{ steps.workflow_info.outputs.commit_sha }}';
            const commitMsg = `${{ steps.commit_info.outputs.commit_msg }}`;
            const commitAuthor = '${{ steps.commit_info.outputs.commit_author }}';
            const triggerEvent = '${{ steps.workflow_info.outputs.trigger_event }}';
            
            const shortSha = commitSha.substring(0, 7);
            const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${commitSha}`;
            
            const issueBody = `## Workflow Failure: ${workflowName}

**Status**: ❌ Failed
**Workflow Run**: [View Run](${workflowUrl}) (ID: ${workflowRunId})
**Trigger**: ${triggerEvent}

### Commit Information
- **Commit**: [${shortSha}](${commitUrl})
- **Message**: ${commitMsg}
- **Author**: ${commitAuthor}

### Next Steps
1. Review the [workflow run](${workflowUrl}) for detailed error logs
2. Check if this is a recurring issue
3. Fix the underlying problem
4. Close this issue when resolved

### Investigation Notes
_Add investigation findings here..._

---
*This issue was automatically created by the Workflow Monitor workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Workflow Failure: ${workflowName} - ${shortSha}`,
              body: issueBody,
              labels: ['workflow-failure', 'ci/cd', 'devops']
            });

      - name: Comment on existing issue
        if: |
          github.event_name == 'workflow_run' && 
          steps.workflow_info.outputs.workflow_conclusion == 'failure' &&
          steps.check_issue.outputs.issue_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ steps.workflow_info.outputs.workflow_name }}';
            const workflowUrl = '${{ steps.workflow_info.outputs.workflow_url }}';
            const workflowRunId = '${{ steps.workflow_info.outputs.workflow_run_id }}';
            const commitSha = '${{ steps.workflow_info.outputs.commit_sha }}';
            
            const shortSha = commitSha.substring(0, 7);
            const commentBody = `Another failure detected for **${workflowName}**:
            
- **Run**: [${workflowRunId}](${workflowUrl})
- **Commit**: ${shortSha}
- **Time**: ${new Date().toISOString()}

This appears to be a recurring issue. Please investigate.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ steps.check_issue.outputs.issue_number }}'),
              body: commentBody
            });

      - name: Generate workflow status report
        id: status_report
        if: always()
        run: |
          mkdir -p .workflow/progress/workflow-status
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DATE=$(date -u +"%Y-%m-%d")
          
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            WORKFLOW_NAME="${{ steps.workflow_info.outputs.workflow_name }}"
            WORKFLOW_CONCLUSION="${{ steps.workflow_info.outputs.workflow_conclusion }}"
            WORKFLOW_RUN_ID="${{ steps.workflow_info.outputs.workflow_run_id }}"
            WORKFLOW_URL="${{ steps.workflow_info.outputs.workflow_url }}"
            COMMIT_SHA="${{ steps.workflow_info.outputs.commit_sha }}"
            
            STATUS_FILE=".workflow/progress/workflow-status/${WORKFLOW_NAME,,}-status.md"
            
            # Create or update status file
            cat > "$STATUS_FILE" << EOF
# ${WORKFLOW_NAME} Workflow Status

**Last Run**: ${TIMESTAMP}
**Status**: $([ "$WORKFLOW_CONCLUSION" = "success" ] && echo "✅ Success" || echo "❌ Failed")
**Run ID**: ${WORKFLOW_RUN_ID}
**Workflow URL**: ${WORKFLOW_URL}
**Commit**: ${COMMIT_SHA:0:7}

## Latest Run Details

- **Conclusion**: ${WORKFLOW_CONCLUSION}
- **Trigger**: ${{ steps.workflow_info.outputs.trigger_event }}
- **Run ID**: ${WORKFLOW_RUN_ID}
- **View Run**: [${WORKFLOW_URL}](${WORKFLOW_URL})

## Recent History

### ${DATE}
- **Status**: $([ "$WORKFLOW_CONCLUSION" = "success" ] && echo "✅ Success" || echo "❌ Failed")
- **Run**: [${WORKFLOW_RUN_ID}](${WORKFLOW_URL})
- **Commit**: [${COMMIT_SHA:0:7}](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})

---
*Last updated: ${TIMESTAMP}*
*Status file auto-generated by Workflow Monitor*
EOF
          else
            # Scheduled or manual run - generate summary
            STATUS_FILE=".workflow/progress/workflow-status/overview.md"
            cat > "$STATUS_FILE" << EOF
# Workflow Status Overview

**Generated**: ${TIMESTAMP}

## Workflow Status

Check individual workflow status files for detailed information:
- \`test-status.md\` - Test workflow
- \`build-status.md\` - Build workflow  
- \`deploy-status.md\` - Deploy workflow
- \`security-status.md\` - Security workflow
- \`bundle-size-status.md\` - Bundle Size workflow

## Quick Status

_Individual workflow status files will be updated on next workflow run._

---
*Last updated: ${TIMESTAMP}*
*Generated by Workflow Monitor on scheduled/manual run*
EOF
          fi
          
          echo "status_file=$STATUS_FILE" >> $GITHUB_OUTPUT

      - name: Create workflow summary
        if: github.event_name == 'workflow_run'
        run: |
          WORKFLOW_NAME="${{ steps.workflow_info.outputs.workflow_name }}"
          WORKFLOW_CONCLUSION="${{ steps.workflow_info.outputs.workflow_conclusion }}"
          WORKFLOW_URL="${{ steps.workflow_info.outputs.workflow_url }}"
          
          if [ "$WORKFLOW_CONCLUSION" = "success" ]; then
            EMOJI="✅"
            STATUS="Success"
          else
            EMOJI="❌"
            STATUS="Failed"
          fi
          
          echo "## Workflow Monitor Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${EMOJI} **${WORKFLOW_NAME}** - ${STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Workflow Run](${WORKFLOW_URL})" >> $GITHUB_STEP_SUMMARY
          
          if [ "$WORKFLOW_CONCLUSION" = "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ A GitHub issue has been created or updated for this failure." >> $GITHUB_STEP_SUMMARY
          fi

