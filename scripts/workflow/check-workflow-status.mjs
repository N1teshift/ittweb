#!/usr/bin/env node

/**
 * Check Workflow Status Script
 * 
 * Reads workflow status files generated by the Workflow Monitor workflow
 * to provide feedback on GitHub Actions workflow status.
 * 
 * Usage: node scripts/workflow/check-workflow-status.mjs [workflow-name|all]
 * 
 * Options:
 *   workflow-name - Check specific workflow (test, build, deploy, security, bundle-size)
 *   all          - Check all workflows (default)
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const WORKFLOW_STATUS_DIR = path.join(__dirname, '../../.workflow/progress/workflow-status');

const WORKFLOW_NAMES = {
  'test': 'Test',
  'build': 'Build',
  'deploy': 'Deploy',
  'security': 'Security',
  'bundle-size': 'Bundle Size',
};

function readStatusFile(workflowKey) {
  const fileName = `${workflowKey}-status.md`;
  const filePath = path.join(WORKFLOW_STATUS_DIR, fileName);
  
  if (!fs.existsSync(filePath)) {
    return null;
  }
  
  try {
    const content = fs.readFileSync(filePath, 'utf-8');
    
    // Parse status file
    const statusMatch = content.match(/\*\*Status\*\*:\s*(.+)/);
    const lastRunMatch = content.match(/\*\*Last Run\*\*:\s*(.+)/);
    const runIdMatch = content.match(/\*\*Run ID\*\*:\s*(\d+)/);
    const workflowUrlMatch = content.match(/\*\*Workflow URL\*\*:\s*(https?:\/\/[^\s]+)/);
    const commitMatch = content.match(/\*\*Commit\*\*:\s*([a-f0-9]+)/);
    const conclusionMatch = content.match(/- \*\*Status\*\*:\s*(.+)/);
    
    return {
      exists: true,
      status: statusMatch ? statusMatch[1].trim() : 'Unknown',
      lastRun: lastRunMatch ? lastRunMatch[1].trim() : 'Unknown',
      runId: runIdMatch ? runIdMatch[1] : null,
      workflowUrl: workflowUrlMatch ? workflowUrlMatch[1] : null,
      commit: commitMatch ? commitMatch[1] : null,
      conclusion: conclusionMatch ? conclusionMatch[1].trim() : null,
      raw: content,
    };
  } catch (error) {
    return { exists: false, error: error.message };
  }
}

function formatStatus(statusInfo, workflowName) {
  if (!statusInfo || !statusInfo.exists) {
    return {
      workflow: workflowName,
      status: 'â“ Unknown',
      message: 'No status file found - workflow may not have run recently',
      available: false,
    };
  }
  
  const isSuccess = statusInfo.status.includes('âœ…') || statusInfo.status.includes('Success');
  const isFailure = statusInfo.status.includes('âŒ') || statusInfo.status.includes('Failed');
  
  return {
    workflow: workflowName,
    status: statusInfo.status,
    lastRun: statusInfo.lastRun,
    runId: statusInfo.runId,
    workflowUrl: statusInfo.workflowUrl,
    commit: statusInfo.commit,
    success: isSuccess,
    failure: isFailure,
    available: true,
  };
}

function formatOutput(results, format = 'human') {
  if (format === 'json') {
    return JSON.stringify(results, null, 2);
  }
  
  // Human-readable format
  let output = '\nðŸ“Š GitHub Actions Workflow Status\n';
  output += '='.repeat(50) + '\n\n';
  
  for (const result of results) {
    output += `${result.workflow}:\n`;
    
    if (!result.available) {
      output += `  Status: ${result.status}\n`;
      output += `  Message: ${result.message}\n`;
    } else {
      output += `  Status: ${result.status}\n`;
      output += `  Last Run: ${result.lastRun}\n`;
      if (result.runId) {
        output += `  Run ID: ${result.runId}\n`;
      }
      if (result.commit) {
        output += `  Commit: ${result.commit}\n`;
      }
      if (result.workflowUrl) {
        output += `  URL: ${result.workflowUrl}\n`;
      }
    }
    
    output += '\n';
  }
  
  // Summary
  const total = results.length;
  const available = results.filter(r => r.available).length;
  const successes = results.filter(r => r.success).length;
  const failures = results.filter(r => r.failure).length;
  const unknown = total - available;
  
  output += 'Summary:\n';
  output += `  Total Workflows: ${total}\n`;
  output += `  âœ… Successful: ${successes}\n`;
  output += `  âŒ Failed: ${failures}\n`;
  output += `  â“ Unknown: ${unknown}\n`;
  
  if (failures > 0) {
    output += '\nâš ï¸  Warning: Some workflows have failed. Check GitHub issues for details.\n';
  }
  
  return output;
}

function main() {
  const workflowName = process.argv[2] || 'all';
  const format = process.argv[3] || 'human';
  
  let workflowsToCheck = [];
  
  if (workflowName === 'all') {
    workflowsToCheck = Object.keys(WORKFLOW_NAMES);
  } else {
    const workflowKey = workflowName.toLowerCase().replace(/\s+/g, '-');
    if (!WORKFLOW_NAMES[workflowKey]) {
      console.error(`Unknown workflow: ${workflowName}`);
      console.error(`Available workflows: ${Object.keys(WORKFLOW_NAMES).join(', ')}`);
      process.exit(1);
    }
    workflowsToCheck = [workflowKey];
  }
  
  const results = workflowsToCheck.map(workflowKey => {
    const statusInfo = readStatusFile(workflowKey);
    return formatStatus(statusInfo, WORKFLOW_NAMES[workflowKey]);
  });
  
  const output = formatOutput(results, format);
  console.log(output);
}

main();

